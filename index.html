<!doctype html>
<html>
  <head>
    <meta charset="utf8" />
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }
      body {
        box-sizing: border-box;
        padding: 24px;
      }
      * {
        font-size: 24px;
        line-height: 48px;
        font-family: monospace;
        margin: 0;
        padding: 0;
      }
      #src {
        width: 100%;
        height: 75%;
        border: none;
        resize: none;
        outline: none;
      }
      #output {
        width: 100%;
        height: 25%;
      }
      #target {
        display: inline-block;
        min-width: 200px;
        border: none;
        outline: none;
      }
    </style>
  </head>
  <body>
    <textarea id="src" class="language-python"></textarea>
    <div id="output">
      <div>Target: <input id="target" /></div>
      <div>Output: <span id="stdout"></span></div>
    </div>
    <script src="pyodide/pyodide.js"></script>
    <script>
      let src = document.querySelector('textarea')
      let stdout = document.querySelector('#stdout')
      let target = document.querySelector('#target')
      let pyodide

      async function execute() {
        if (!pyodide) return

        stdout.textContent = ''
        try {
          await pyodide.runPythonAsync(src.value)
        } catch (e) {
          if (!stdout.textContent) {
            stdout.textContent = e.message
          }
        }

        if (stdout.textContent.includes('line')) {
          stdout.textContent = stdout.textContent.replace(/File "<exec>", line (\d+).*\n(.*)/g, (_, a, b) => {
            return b + ' (line ' + a + ')'
          })
        } else {
          if (target.value == stdout.textContent.trim().replace(/[\r\n]+/g, ' ')) {
            stdout.textContent += '✔️'
          } else {
            stdout.textContent += '❌️'
          }
        }

        location.hash = '#' + btoa(JSON.stringify([src.value, target.value]))
      }

      src.addEventListener('keydown', (e) => {
        if (e.key == 'Tab') {
          e.preventDefault()
          src.setRangeText('    ', src.selectionStart, src.selectionEnd, 'end')
        }
      })

      async function init() {
        pyodide = await loadPyodide({
          indexURL: 'pyodide/',
          stdout: (text) => {
            stdout.textContent += text
          },
          stderr: (text) => {
            stdout.textContent += text
          },
        })

        if (location.hash.length > 1) {
          ;[src.value, target.value] = JSON.parse(atob(location.hash.substring(1)))
        }

        src.addEventListener('input', execute)
        target.addEventListener('input', execute)
        await execute()
        window.pyodideReady = true
      }

      init()
    </script>
  </body>
</html>
